<!DOCTYPE html>
<html ng-app="app" data-ng-controller="ctrl">
<head>
    <meta charset="utf-8">
    <title>Health Monitoring - {{details.Name}}</title>
    <link rel="icon" href="/static/favicon.ico">
    <script src="/static/angular.min.js"></script>
    <link rel="stylesheet" href="/static/details.css">
    <base href="/dashboard" target="_blank"/>
</head>
<body>
<h1>Endpoint</h1>
<table>
    <tr><td>Id:</td><td>{{details.Id}}</td></tr>
    <tr><td>Name:</td><td>{{details.Name}}</td></tr>
    <tr><td>Address:</td><td>{{details.Address}}</td></tr>
    <tr><td>MonitorType:</td><td>{{details.MonitorType}}</td></tr>
    <tr><td>Group:</td><td>{{details.Group}}</td></tr>
    <tr><td>Status:</td><td>{{details.Status}}</td></tr>
    <tr><td>LastCheckUtc:</td><td>{{details.LastCheckUtc}}</td></tr>
    <tr><td>LastResponseTime:</td><td>{{details.LastResponseTime}}</td></tr>
</table>
<h1>Details</h1>
<table>
    <tr ng-repeat="(key,value) in details.Details"><td>{{key}}</td><td>{{value}}</td></tr>
</table>
<h1>Stats</h1>
<table>
    <tr ng-repeat="s in stats"><td>{{s.Status}}</td><td>{{s.CheckTimeUtc}}</td><td>{{s.ResponseTime}}</td></tr>
</table>

    <div class="chart" style="width:{{graph.width}}px; height:{{graph.height}}px;">
        <!-- Labels -->
        <div class="y" style="width:{{graph.height}}px;">Response Time</div>
        <div class="x">Time</div>
        <!-- Data -->
        <svg style="width:{{graph.width}}px; height:{{graph.height}}px;">
            <line ng-repeat="line in stats.lines" class="{{line.status}}" x1="{{$index / stats.lines.length * graph.width }}" y1="{{stats.lines[$index - 1].value / stats.max * graph.height}}" x2="{{($index + 1) / stats.lines.length * graph.width}}" y2="{{line.value / stats.max * graph.height}}"></line>
        </svg>
    </div>
<script>
    var app = angular.module('app', []);

    app.config(function ($locationProvider) {
        $locationProvider.html5Mode(true);
    });

    app.controller('ctrl', function ($scope, $http, $location) {

        $scope.details = {};
        $scope.stats = [];
        $scope.graph = { width: 800, height: 400};

        $scope.updateDetails = function() {
            $http.get("/api/endpoints/" + $location.search().id)
                .success(function(response) {
                    $scope.details = response;
                })
                .error(function(data, status) {
                    $scope.details = {};
                });
        };

        function parseDuration(timeSpan) {
            if (timeSpan == null) {
                return 0;
            }

            var parts = timeSpan.split(".");

            var ms = 0;
            if (parts.length > 1)
                ms = +(parts[1].substring(0, 3));

            parts = parts[0].split(':');

            var mul = 1000;
            for (var i = parts.length - 1; i >= 0; --i) {
                ms += (+(parts[i])) * mul;
                mul *= 60;
            }
            return ms;
        }

        function convert(stats) {
            var max = 0;
            var r = [];
            for (var i = 0; i < stats.length; ++i) {
                var duration = parseDuration(stats[i].ResponseTime);
                if (max < duration) {
                    max = duration;
                }
                r.push({ status: stats[i].Status, value: duration, duration: stats[i].ResponseTime, time: stats[i].CheckTimeUtc });
            }
            return { lines: r, max: max };
        }

        $scope.updateStats = function() {
            $http.get("/api/endpoints/" + $location.search().id + "/stats?limitDays=1")
                .success(function(response) {
                    $scope.stats = convert(response);
                })
                .error(function(data, status) {
                    $scope.stats = [];
                });
        };

        $scope.update = function() {
            $scope.updateDetails();
            $scope.updateStats();
        }

        $scope.update();
        setInterval($scope.update, 3000);
    });
</script>
</body>
</html>